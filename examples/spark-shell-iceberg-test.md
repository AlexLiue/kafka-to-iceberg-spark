# Spark Shell Iceberg 使用测试

## Spark shell 启动

要在 Spark shell 中使用 Iceberg，请使用以下--packages选项：
其中  omit uri to use the same URI as Spark: hive.metastore.uris in hive-site.xml  
```shell

/opt/run/spark3/bin/spark-shell --packages org.apache.iceberg:iceberg-spark3-runtime:0.13.0  \
--conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions \
--conf spark.sql.catalog.hive_prod=org.apache.iceberg.spark.SparkCatalog \
--conf spark.sql.catalog.hive_prod.type=hive \
--conf spark.sql.catalog.hive_prod.uri=thrift://hadoop:9083

/opt/run/spark3/bin/spark-shell --packages org.apache.iceberg:iceberg-spark-runtime-3.2_2.12:0.13.1  \
spark.sql.catalog.hive_prod = org.apache.iceberg.spark.SparkCatalog \
spark.sql.catalog.hive_prod.type = hive \
spark.sql.catalog.hive_prod.uri = thrift://hadoop:9083

```


    val df1 = Seq(
      (1, "Karol", 19),
      (2, "Abby", 20),
      (3, "Zena", 18)
    ).toDF("id", "name", "age")



22/02/24 13:50:15 INFO IcebergWriter: Generate Rdd[Row], RDD collect [

Array(
[test,db_gb18030_test,tbl_test,1645157221283,0,mysql-bin.000003,57965,null,null,null,r,1645157221285,test.db_gb18030_test.tbl_test,0,0,1645157221760,1,v1,v2,1,12,1645157193000,1645157193000],
[test,db_gb18030_test,tbl_test,1645157276000,1,mysql-bin.000003,58212,null,null,null,u,1645157276708,test.db_gb18030_test.tbl_test,0,1,1645157276913,1,v1,v2,2,12,1645157193000,1645157276000],
[test,db_gb18030_test,tbl_test,1645163763000,1,mysql-bin.000003,58592,null,null,null,u,1645163829136,test.db_gb18030_test.tbl_test,0,2,1645163829428,1,v1,v2,3,12,1645157193000,1645163763000], 
[test,db_gb18030_test,tbl_test,1645163763000,1,mysql-bin.000003,58774,null,null,null,u,1645163829137,test.db_gb18030_test.tbl_test,0,3,1645163829429,1,v1,v2,4,12,1645157193000,1645163763000],
[test,db_gb18030_test,tbl_test,1645163829000,1,mysql-bin.000003,59169,null,null,null,u,1645163838692,test.db_gb18030_test.tbl_test,0,4,1645163838952,1,v1,v2,3,12,1645157193000,1645163829000], 
[test,db_gb18030_test,tbl_test,1645163829000,1,mysql-bin.000003,59351,null,null,null,u,1645163838693,test.db_gb18030_test.tbl_test,0,5,1645163838953,1,v1,v2,4,12,1645157193000,1645163829000],
[test,db_gb18030_test,tbl_test,1645163838000,1,mysql-bin.000003,59746,null,null,null,u,1645163880683,test.db_gb18030_test.tbl_test,0,6,1645163881065,1,v1,v2,3,12,1645157193000,1645163838000],
[test,db_gb18030_test,tbl_test,1645163838000,1,mysql-bin.000003,59928,null,null,null,u,1645163880684,test.db_gb18030_test.tbl_test,0,7,1645163881066,1,v1,v2,4,12,1645157193000,1645163838000],
[test,db_gb18030_test,tbl_test,1645163880000,1,mysql-bin.000003,60323,null,null,null,u,1645163889084,test.db_gb18030_test.tbl_test,0,8,1645163889585,1,v1,v2,3,12,1645157193000,1645163880000], 
[test,db_gb18030_test,tbl_test,1645163880000,1,mysql-bin.000003,60505,null,null,null,u,1645163889085,test.db_gb18030_test.tbl_test,0,9,1645163889585,1,v1,v2,4,12,1645157193000,1645163880000], 
[test,db_gb18030_test,tbl_test,1645163889000,1,mysql-bin.000003,60900,e45b718e-906f-11ec-89e3-0242c0a8640a:117,1,1,u,1645164439953,test.db_gb18030_test.tbl_test,0,10,1645164440028,1,v1,v2,3,12,1645157193000,1645163889000],
[test,db_gb18030_test,tbl_test,1645163889000,1,mysql-bin.000003,61082,e45b718e-906f-11ec-89e3-0242c0a8640a:117,2,2,u,1645164439954,test.db_gb18030_test.tbl_test,0,11,1645164440029,1,v1,v2,4,12,1645157193000,1645163889000])
]
22/02/24 13:50:15 INFO Kafka2Iceberg: commitOffsetRangers: [OffsetRange(topic: 'test.db_gb18030_test.tbl_test', partition: 0, range: [0 -> 12]),OffsetRange(topic: 'test.db_gb18030_test.tbl_test', partition: 1, range: [0 -> 0]),OffsetRange(topic: 'test.db_gb18030_test.tbl_test', partition: 2, range: [0 -> 0])]







{"source":{"version":"1.8.0.Final","connector":"mysql","name":"test","ts_ms":1645408590407,"snapshot":{"string":"false"},"db":"","sequence":null,"table":{"string":""},"server_id":1,"gtid":{"string":"e45b718e-906f-11ec-89e3-0242c0a8640a:204"},"file":"mysql-bin.000006","pos":641,"row":0,"thread":null,"query":null},"databaseName":{"string":""},"schemaName":null,"ddl":{"string":"/* ApplicationName=DBeaver 21.3.4 - Main */ ALTER TABLE spark.tbl_spark_streaming_conf CHANGE conf_id group_id varchar(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL COMMENT '������������������������'"},"tableChanges":[]}
{"source":{"version":"1.8.0.Final","connector":"mysql","name":"test","ts_ms":1645408590407,"snapshot":{"string":"false"},"db":"","sequence":null,"table":{"string":""},"server_id":1,"gtid":{"string":"e45b718e-906f-11ec-89e3-0242c0a8640a:204"},"file":"mysql-bin.000006","pos":641,"row":0,"thread":null,"query":null},"databaseName":{"string":""},"schemaName":null,"ddl":{"string":"/* ApplicationName=DBeaver 21.3.4 - Main */ ALTER TABLE spark.tbl_spark_streaming_conf CHANGE conf_id group_id varchar(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL COMMENT '������������������������'"},"tableChanges":[]}
{"source":{"version":"1.8.0.Final","connector":"mysql","name":"test","ts_ms":1645473830222,"snapshot":{"string":"false"},"db":"","sequence":null,"table":{"string":""},"server_id":1,"gtid":{"string":"e45b718e-906f-11ec-89e3-0242c0a8640a:204"},"file":"mysql-bin.000006","pos":641,"row":0,"thread":null,"query":null},"databaseName":{"string":""},"schemaName":null,"ddl":{"string":"/* ApplicationName=DBeaver 21.3.4 - Main */ ALTER TABLE spark.tbl_spark_streaming_conf CHANGE conf_id group_id varchar(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL COMMENT '������������������������'"},"tableChanges":[]}
{"source":{"version":"1.8.0.Final","connector":"mysql","name":"test","ts_ms":1645473830224,"snapshot":{"string":"false"},"db":"","sequence":null,"table":{"string":""},"server_id":1,"gtid":{"string":"e45b718e-906f-11ec-89e3-0242c0a8640a:204"},"file":"mysql-bin.000006","pos":641,"row":0,"thread":null,"query":null},"databaseName":{"string":""},"schemaName":null,"ddl":{"string":"/* ApplicationName=DBeaver 21.3.4 - Main */ ALTER TABLE spark.tbl_spark_streaming_conf CHANGE conf_id group_id varchar(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL COMMENT '������������������������'"},"tableChanges":[]}
{"source":{"version":"1.8.0.Final","connector":"mysql","name":"test","ts_ms":1645495404152,"snapshot":{"string":"false"},"db":"","sequence":null,"table":{"string":""},"server_id":1,"gtid":{"string":"e45b718e-906f-11ec-89e3-0242c0a8640a:204"},"file":"mysql-bin.000006","pos":641,"row":0,"thread":null,"query":null},"databaseName":{"string":""},"schemaName":null,"ddl":{"string":"/* ApplicationName=DBeaver 21.3.4 - Main */ ALTER TABLE spark.tbl_spark_streaming_conf CHANGE conf_id group_id varchar(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL COMMENT '������������������������'"},"tableChanges":[]}
{"source":{"version":"1.8.0.Final","connector":"mysql","name":"test","ts_ms":1645495404158,"snapshot":{"string":"false"},"db":"","sequence":null,"table":{"string":""},"server_id":1,"gtid":{"string":"e45b718e-906f-11ec-89e3-0242c0a8640a:204"},"file":"mysql-bin.000006","pos":641,"row":0,"thread":null,"query":null},"databaseName":{"string":""},"schemaName":null,"ddl":{"string":"/* ApplicationName=DBeaver 21.3.4 - Main */ ALTER TABLE spark.tbl_spark_streaming_conf CHANGE conf_id group_id varchar(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL COMMENT '������������������������'"},"tableChanges":[]}
{"source":{"version":"1.8.0.Final","connector":"mysql","name":"test","ts_ms":1645596886838,"snapshot":{"string":"false"},"db":"","sequence":null,"table":{"string":""},"server_id":1,"gtid":{"string":"e45b718e-906f-11ec-89e3-0242c0a8640a:204"},"file":"mysql-bin.000006","pos":641,"row":0,"thread":null,"query":null},"databaseName":{"string":""},"schemaName":null,"ddl":{"string":"/* ApplicationName=DBeaver 21.3.4 - Main */ ALTER TABLE spark.tbl_spark_streaming_conf CHANGE conf_id group_id varchar(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL COMMENT '������������������������'"},"tableChanges":[]}
{"source":{"version":"1.8.0.Final","connector":"mysql","name":"test","ts_ms":1645596886840,"snapshot":{"string":"false"},"db":"","sequence":null,"table":{"string":""},"server_id":1,"gtid":{"string":"e45b718e-906f-11ec-89e3-0242c0a8640a:204"},"file":"mysql-bin.000006","pos":641,"row":0,"thread":null,"query":null},"databaseName":{"string":""},"schemaName":null,"ddl":{"string":"/* ApplicationName=DBeaver 21.3.4 - Main */ ALTER TABLE spark.tbl_spark_streaming_conf CHANGE conf_id group_id varchar(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL COMMENT '������������������������'"},"tableChanges":[]}
{"source":{"version":"1.8.0.Final","connector":"mysql","name":"test","ts_ms":1645690393801,"snapshot":{"string":"false"},"db":"db_gb18030_test","sequence":null,"table":{"string":"tbl_test"},"server_id":1,"gtid":{"string":"e45b718e-906f-11ec-89e3-0242c0a8640a:218"},"file":"mysql-bin.000010","pos":8243,"row":0,"thread":null,"query":null},"databaseName":{"string":"db_gb18030_test"},"schemaName":null,"ddl":{"string":"ALTER TABLE db_gb18030_test.tbl_test ADD COLUMN C5 varchar(45) default null after C4"},"tableChanges":[{"type":"ALTER","id":"\"db_gb18030_test\".\"tbl_test\"","table":{"defaultCharsetName":{"string":"gb18030"},"primaryKeyColumnNames":{"array":["ID"]},"columns":[{"name":"ID","jdbcType":4,"nativeType":null,"typeName":"INT","typeExpression":{"string":"INT"},"charsetName":null,"length":null,"scale":null,"position":1,"optional":{"boolean":false},"autoIncremented":{"boolean":true},"generated":{"boolean":true},"comment":null},{"name":"C1","jdbcType":12,"nativeType":null,"typeName":"VARCHAR","typeExpression":{"string":"VARCHAR"},"charsetName":{"string":"gb18030"},"length":{"int":45},"scale":null,"position":2,"optional":{"boolean":true},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"C2","jdbcType":12,"nativeType":null,"typeName":"VARCHAR","typeExpression":{"string":"VARCHAR"},"charsetName":{"string":"gb18030"},"length":{"int":45},"scale":null,"position":3,"optional":{"boolean":false},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"C3","jdbcType":4,"nativeType":null,"typeName":"INT","typeExpression":{"string":"INT"},"charsetName":null,"length":null,"scale":null,"position":4,"optional":{"boolean":true},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"C4","jdbcType":-5,"nativeType":null,"typeName":"BIGINT","typeExpression":{"string":"BIGINT"},"charsetName":null,"length":null,"scale":null,"position":5,"optional":{"boolean":true},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"C5","jdbcType":12,"nativeType":null,"typeName":"VARCHAR","typeExpression":{"string":"VARCHAR"},"charsetName":{"string":"gb18030"},"length":{"int":45},"scale":null,"position":6,"optional":{"boolean":true},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"CREATE_TIME","jdbcType":93,"nativeType":null,"typeName":"DATETIME","typeExpression":{"string":"DATETIME"},"charsetName":null,"length":null,"scale":null,"position":7,"optional":{"boolean":false},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"UPDATE_TIME","jdbcType":93,"nativeType":null,"typeName":"DATETIME","typeExpression":{"string":"DATETIME"},"charsetName":null,"length":null,"scale":null,"position":8,"optional":{"boolean":false},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null}],"comment":null}}]}



22/02/24 16:32:30 INFO Kafka2Iceberg: OffsetRanges:   [OffsetRange(topic: 'test.db_gb18030_test.tbl_test', partition: 1, range: [0 -> 1]),OffsetRange(topic: 'test.db_gb18030_test.tbl_test', partition: 0, range: [0 -> 13]),OffsetRange(topic: 'test.db_gb18030_test.tbl_test', partition: 2, range: [0 -> 0])]
22/02/24 16:32:30 INFO Kafka2Iceberg: partitionOffsets: [test.db_gb18030_test.tbl_test:0 -> PartitionOffset(topic: 'test.db_gb18030_test.tbl_test', partition: 0, range: [0 -> 13], curOffset: 0),test.db_gb18030_test.tbl_test:1 -> PartitionOffset(topic: 'test.db_gb18030_test.tbl_test', partition: 1, range: [0 -> 1], curOffset: 0),test.db_gb18030_test.tbl_test:2 -> PartitionOffset(topic: 'test.db_gb18030_test.tbl_test', partition: 2, range: [0 -> 0], curOffset: 0)]

22/02/24 16:32:30 INFO IcebergWriter: Generate Rdd[Row], RDD collect [Array([], [test,db_gb18030_test,tbl_test,1645157221283,0,mysql-bin.000003,57965,null,null,null,r,1645157221285,test.db_gb18030_test.tbl_test,0,0,1645157221760,1,v1,v2,1,12,1645157193000,1645157193000], [test,db_gb18030_test,tbl_test,1645157276000,1,mysql-bin.000003,58212,null,null,null,u,1645157276708,test.db_gb18030_test.tbl_test,0,1,1645157276913,1,v1,v2,2,12,1645157193000,1645157276000], [test,db_gb18030_test,tbl_test,1645163763000,1,mysql-bin.000003,58592,null,null,null,u,1645163829136,test.db_gb18030_test.tbl_test,0,2,1645163829428,1,v1,v2,3,12,1645157193000,1645163763000], [test,db_gb18030_test,tbl_test,1645163763000,1,mysql-bin.000003,58774,null,null,null,u,1645163829137,test.db_gb18030_test.tbl_test,0,3,1645163829429,1,v1,v2,4,12,1645157193000,1645163763000], [test,db_gb18030_test,tbl_test,1645163829000,1,mysql-bin.000003,59169,null,null,null,u,1645163838692,test.db_gb18030_test.tbl_test,0,4,1645163838952,1,v1,v2,3,12,1645157193000,1645163829000], [test,db_gb18030_test,tbl_test,1645163829000,1,mysql-bin.000003,59351,null,null,null,u,1645163838693,test.db_gb18030_test.tbl_test,0,5,1645163838953,1,v1,v2,4,12,1645157193000,1645163829000], [test,db_gb18030_test,tbl_test,1645163838000,1,mysql-bin.000003,59746,null,null,null,u,1645163880683,test.db_gb18030_test.tbl_test,0,6,1645163881065,1,v1,v2,3,12,1645157193000,1645163838000], [test,db_gb18030_test,tbl_test,1645163838000,1,mysql-bin.000003,59928,null,null,null,u,1645163880684,test.db_gb18030_test.tbl_test,0,7,1645163881066,1,v1,v2,4,12,1645157193000,1645163838000], [test,db_gb18030_test,tbl_test,1645163880000,1,mysql-bin.000003,60323,null,null,null,u,1645163889084,test.db_gb18030_test.tbl_test,0,8,1645163889585,1,v1,v2,3,12,1645157193000,1645163880000], [test,db_gb18030_test,tbl_test,1645163880000,1,mysql-bin.000003,60505,null,null,null,u,1645163889085,test.db_gb18030_test.tbl_test,0,9,1645163889585,1,v1,v2,4,12,1645157193000,1645163880000], [test,db_gb18030_test,tbl_test,1645163889000,1,mysql-bin.000003,60900,e45b718e-906f-11ec-89e3-0242c0a8640a:117,1,1,u,1645164439953,test.db_gb18030_test.tbl_test,0,10,1645164440028,1,v1,v2,3,12,1645157193000,1645163889000], [test,db_gb18030_test,tbl_test,1645163889000,1,mysql-bin.000003,61082,e45b718e-906f-11ec-89e3-0242c0a8640a:117,2,2,u,1645164439954,test.db_gb18030_test.tbl_test,0,11,1645164440029,1,v1,v2,4,12,1645157193000,1645163889000], [])]
22/02/24 16:32:30 INFO Kafka2Iceberg: commitOffsetRangers: [
OffsetRange(topic: 'test.db_gb18030_test.tbl_test', partition: 0, range: [0 -> 12]),OffsetRange(topic: 'test.db_gb18030_test.tbl_test', partition: 1, range: [0 -> 0]),OffsetRange(topic: 'test.db_gb18030_test.tbl_test', partition: 2, range: [0 -> 0])]
22/02/24 16:32:45 INFO SubscriptionState: [Consumer clientId=consumer-g1-1-1, groupId=g1-1] Seeking to LATEST offset of partition test.db_gb18030_test.tbl_test-1
22/02/24 16:32:45 INFO SubscriptionState: [Consumer clientId=consumer-g1-1-1, groupId=g1-1] Seeking to LATEST offset of partition test.db_gb18030_test.tbl_test-0
22/02/24 16:32:45 INFO SubscriptionState: [Consumer clientId=consumer-g1-1-1, groupId=g1-1] Seeking to LATEST offset of partition test.db_gb18030_test.tbl_test-2
22/02/24 16:32:45 INFO SubscriptionState: [Consumer clientId=consumer-g1-1-1, groupId=g1-1] Resetting offset for partition test.db_gb18030_test.tbl_test-2 to offset 0.
22/02/24 16:32:45 INFO SubscriptionState: [Consumer clientId=consumer-g1-1-1, groupId=g1-1] Resetting offset for partition test.db_gb18030_test.tbl_test-0 to offset 13.
22/02/24 16:32:45 INFO SubscriptionState: [Consumer clientId=consumer-g1-1-1, groupId=g1-1] Resetting offset for partition test.db_gb18030_test.tbl_test-1 to offset 1.






{"source":{"version":"1.8.0.Final","connector":"mysql","name":"test","ts_ms":1645690393801,"snapshot":{"string":"false"},"db":"db_gb18030_test","sequence":null,"table":{"string":"tbl_test"},"server_id":1,"gtid":{"string":"e45b718e-906f-11ec-89e3-0242c0a8640a:218"},"file":"mysql-bin.000010","pos":8243,"row":0,"thread":null,"query":null},"databaseName":{"string":"db_gb18030_test"},"schemaName":null,"ddl":{"string":"ALTER TABLE db_gb18030_test.tbl_test ADD COLUMN C5 varchar(45) default null after C4"},"tableChanges":[{"type":"ALTER","id":"\"db_gb18030_test\".\"tbl_test\"","table":{"defaultCharsetName":{"string":"gb18030"},"primaryKeyColumnNames":{"array":["ID"]},"columns":[{"name":"ID","jdbcType":4,"nativeType":null,"typeName":"INT","typeExpression":{"string":"INT"},"charsetName":null,"length":null,"scale":null,"position":1,"optional":{"boolean":false},"autoIncremented":{"boolean":true},"generated":{"boolean":true},"comment":null},{"name":"C1","jdbcType":12,"nativeType":null,"typeName":"VARCHAR","typeExpression":{"string":"VARCHAR"},"charsetName":{"string":"gb18030"},"length":{"int":45},"scale":null,"position":2,"optional":{"boolean":true},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"C2","jdbcType":12,"nativeType":null,"typeName":"VARCHAR","typeExpression":{"string":"VARCHAR"},"charsetName":{"string":"gb18030"},"length":{"int":45},"scale":null,"position":3,"optional":{"boolean":false},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"C3","jdbcType":4,"nativeType":null,"typeName":"INT","typeExpression":{"string":"INT"},"charsetName":null,"length":null,"scale":null,"position":4,"optional":{"boolean":true},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"C4","jdbcType":-5,"nativeType":null,"typeName":"BIGINT","typeExpression":{"string":"BIGINT"},"charsetName":null,"length":null,"scale":null,"position":5,"optional":{"boolean":true},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"C5","jdbcType":12,"nativeType":null,"typeName":"VARCHAR","typeExpression":{"string":"VARCHAR"},"charsetName":{"string":"gb18030"},"length":{"int":45},"scale":null,"position":6,"optional":{"boolean":true},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"CREATE_TIME","jdbcType":93,"nativeType":null,"typeName":"DATETIME","typeExpression":{"string":"DATETIME"},"charsetName":null,"length":null,"scale":null,"position":7,"optional":{"boolean":false},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null},{"name":"UPDATE_TIME","jdbcType":93,"nativeType":null,"typeName":"DATETIME","typeExpression":{"string":"DATETIME"},"charsetName":null,"length":null,"scale":null,"position":8,"optional":{"boolean":false},"autoIncremented":{"boolean":false},"generated":{"boolean":false},"comment":null}],"comment":null}}]}
